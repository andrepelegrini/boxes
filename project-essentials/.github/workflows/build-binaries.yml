# .github/workflows/build-binaries.yml
name: Build micro-service binaries (macOS-Linux-Windows)

on:
  push:
    branches: [ main ]          # ‚Üê sua branch de trabalho
  pull_request:
    branches: [ main ]

jobs:
  pkg:
    # 3 SO √ó 6 servi√ßos = 18 jobs
    strategy:
      fail-fast: false
      matrix:
        os:   [macos-latest, ubuntu-latest, windows-latest]
        service:
          - ai-service
          - database-service
          - oauth-service
          - queue-service
          - socket-service
          - whatsapp-service

    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash         # GitHub fornece Bash tamb√©m no runner Windows

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: ‚ö° Cache node_modules
        uses: actions/cache@v4
        with:
          path: ${{ matrix.service }}/node_modules
          key:  ${{ runner.os }}-node20-${{ hashFiles(format('{0}/package-lock.json', matrix.service)) }}

      - name: üîß Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: üìú Build TypeScript
        working-directory: ${{ matrix.service }}
        run: |
          npm ci
          npm run build

      # Define o alvo correto (macos / linux / win) e sufixo .exe p/ Windows
      - name: üè∑Ô∏è  Set env PKG_TARGET / SUFFIX
        run: |
          case "${{ runner.os }}" in
            macOS)   echo "PKG_TARGET=node20-macos"      >> "$GITHUB_ENV";;
            Linux)   echo "PKG_TARGET=node20-linux-x64"  >> "$GITHUB_ENV";;
            Windows) echo "PKG_TARGET=node20-win-x64"    >> "$GITHUB_ENV"; \
                     echo "EXE_SUFFIX=.exe"             >> "$GITHUB_ENV";;
          esac

      - name: üõ†Ô∏è  Generate binary
        working-directory: ${{ matrix.service }}
        run: |
          npx pkg . \
            --targets $PKG_TARGET \
            --compress Brotli \
            --out-path ../src-tauri/bin
          mv ../src-tauri/bin/${{ matrix.service }}$EXE_SUFFIX \
             ../src-tauri/bin/${{ matrix.service }}-${{ runner.os }}$EXE_SUFFIX

      - name: ‚§¥Ô∏è  Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-${{ runner.os }}
          path: src-tauri/bin/${{ matrix.service }}-${{ runner.os }}*
